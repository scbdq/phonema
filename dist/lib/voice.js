(function(){const h="phonema.voice.settings.v1",e={voiceURI:null,rate:1,pitch:1,volume:1},l={voices:[],ready:!1};function y(){try{const n=JSON.parse(localStorage.getItem(h)||"{}");Object.assign(e,n||{})}catch{}}function d(){try{localStorage.setItem(h,JSON.stringify(e))}catch{}}function u(){const n=window.speechSynthesis.getVoices();l.voices=n.filter(i=>/ru/i.test(i.lang||"")||/russian/i.test(i.name||""));const o=[/Svetlana|Irina|Milena/i,/Google.*Russian/i,/Microsoft.*Russian/i,/ru/i];if(!e.voiceURI)for(const i of o){const t=l.voices.find(a=>i.test(a.name)||i.test(a.voiceURI));if(t){e.voiceURI=t.voiceURI||t.name;break}}l.ready=!0}function p(){return l.ready||u(),l.voices.find(o=>o.voiceURI===e.voiceURI||o.name===e.voiceURI)||l.voices[0]||null}async function f(n){return new Promise((o,i)=>{try{const t=new SpeechSynthesisUtterance(n),a=p();a&&(t.voice=a),t.lang="ru-RU",t.rate=e.rate,t.pitch=e.pitch,t.volume=e.volume,t.onend=()=>o(),t.onerror=r=>i(r.error||r),window.speechSynthesis.cancel(),window.speechSynthesis.speak(t)}catch{o()}})}function m(){const n=document.getElementById("settings-modal");if(!n)return;const o=document.getElementById("voice-select"),i=document.getElementById("voice-rate"),t=document.getElementById("voice-pitch"),a=document.getElementById("voice-volume"),r=document.getElementById("settings-test"),S=document.getElementById("settings-close");function g(){o.innerHTML="",l.voices.forEach(c=>{const s=document.createElement("option");s.value=c.voiceURI||c.name,s.textContent=`${c.name} (${c.lang})`,s.value===e.voiceURI&&(s.selected=!0),o.appendChild(s)}),i.value=e.rate,t.value=e.pitch,a.value=e.volume}g(),o.onchange=()=>{e.voiceURI=o.value,d()},i.oninput=()=>{e.rate=parseFloat(i.value),d()},t.oninput=()=>{e.pitch=parseFloat(t.value),d()},a.oninput=()=>{e.volume=parseFloat(a.value),d()},r.onclick=()=>f("\u041F\u0440\u0438\u0432\u0435\u0442! \u042D\u0442\u043E \u043F\u0440\u043E\u0432\u0435\u0440\u043A\u0430 \u0433\u043E\u043B\u043E\u0441\u0430. \u041A\u0430\u043A \u0441\u043B\u044B\u0448\u043D\u043E?"),S.onclick=()=>n.classList.add("hidden"),window.addEventListener("keydown",c=>{c.key==="Escape"&&n.classList.add("hidden")});const v=document.querySelector(".site-header");if(v){let c=v.querySelector(".header-actions");c||(c=document.createElement("div"),c.className="header-actions",v.appendChild(c));const s=document.createElement("button");s.className="icon-btn",s.title="\u041D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0438 \u0433\u043E\u043B\u043E\u0441\u0430",s.textContent="\u2699\uFE0F",s.onclick=()=>{g(),n.classList.remove("hidden")},c.appendChild(s)}}function I(){y(),"speechSynthesis"in window&&(u(),window.speechSynthesis.onvoiceschanged=()=>{u(),m()}),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",m):m()}window.Voice={speak:f,get voice(){return p()},settings:e},I()})();
