const{speakSequence,speak,shuffle,setFeedback,updateProgress,wait,clearChildren,initSpeechWarmup}=window.GameUtils,slotsContainer=document.getElementById("melody-slots"),buttonsContainer=document.getElementById("syllable-buttons"),playButton=document.getElementById("play-melody"),clearButton=document.getElementById("clear-melody"),checkButton=document.getElementById("check-melody"),feedback=document.getElementById("feedback"),progress=document.getElementById("progress");initSpeechWarmup();const melodies=shuffle([["\u0442\u0430","\u0442\u0430","\u0442\u0430"],["\u043F\u0430","\u043F\u0430","\u043F\u0430"],["\u043A\u0430","\u043A\u0430","\u043A\u0430"],["\u043D\u0430","\u043D\u0430","\u043D\u0430"],["\u0442\u0430","\u0442\u043E","\u0442\u0443"],["\u043C\u0443","\u043C\u044B","\u043C\u0430"],["\u0432\u0430","\u0432\u0443","\u0432\u043E"],["\u043D\u043E","\u043D\u0443","\u043D\u044B"],["\u043A\u0430","\u043A\u043E","\u043A\u0443"],["\u0442\u0430","\u043A\u0430","\u043F\u0430"],["\u043C\u043E","\u043D\u043E","\u0442\u043E"],["\u0434\u0443","\u043D\u0443","\u043A\u0443"],["\u043F\u043E","\u0432\u043E","\u043D\u043E"],["\u0442\u044B","\u043F\u044B","\u043A\u044B"]]);let currentIndex=0,score=0,currentMelody=null,selection=[];function setupRound(){if(currentIndex>=melodies.length){finishGame();return}currentMelody=melodies[currentIndex],selection=Array(currentMelody.length).fill(null),updateProgress(progress,currentIndex+1,melodies.length),setFeedback(feedback,"\u041F\u043E\u0441\u043B\u0443\u0448\u0430\u0439\u0442\u0435 \u043F\u0435\u0441\u0435\u043D\u043A\u0443 \u0438 \u043F\u043E\u0432\u0442\u043E\u0440\u0438\u0442\u0435 \u0435\u0451, \u043D\u0430\u0436\u0438\u043C\u0430\u044F \u043D\u0430 \u0441\u043B\u043E\u0433\u0438.","info"),clearChildren(slotsContainer),clearChildren(buttonsContainer),selection.forEach((t,n)=>{const l=document.createElement("div");l.className="sequence-slot",l.dataset.index=String(n),l.textContent="\u266A",l.addEventListener("click",()=>clearSlot(n)),slotsContainer.appendChild(l)}),[...new Set(currentMelody)].forEach(t=>{const n=document.createElement("button");n.type="button",n.className="btn btn-secondary",n.textContent=t.toUpperCase(),n.addEventListener("click",()=>addSyllable(t)),buttonsContainer.appendChild(n)}),updateCheckState(),playMelody()}function playMelody(){speakSequence(currentMelody,{speechOptions:{rate:1.05},pause:320})}function addSyllable(e){const t=selection.findIndex(l=>l===null);if(t===-1){setFeedback(feedback,"\u0412\u0441\u0435 \u043D\u043E\u0442\u044B \u0437\u0430\u043F\u043E\u043B\u043D\u0435\u043D\u044B. \u041D\u0430\u0436\u043C\u0438\u0442\u0435 \u043D\u0430 \u0441\u043B\u043E\u0442, \u0447\u0442\u043E\u0431\u044B \u043E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u0435\u0433\u043E.","info");return}selection[t]=e;const n=slotsContainer.querySelector(`.sequence-slot[data-index="${t}"]`);n.textContent=e.toUpperCase(),n.classList.add("filled"),speak(e,{rate:1.05}),updateCheckState()}function clearSlot(e){if(selection[e]===null)return;selection[e]=null;const t=slotsContainer.querySelector(`.sequence-slot[data-index="${e}"]`);t.textContent="\u266A",t.classList.remove("filled"),updateCheckState()}function clearSelection(){selection=selection.map(()=>null),slotsContainer.querySelectorAll(".sequence-slot").forEach(e=>{e.textContent="\u266A",e.classList.remove("filled")}),updateCheckState()}function updateCheckState(){const e=selection.every(t=>t!==null);checkButton.disabled=!e}async function handleCheck(){if(selection.includes(null))return;selection.every((t,n)=>t===currentMelody[n])?(score+=1,setFeedback(feedback,"\u0412\u044B \u0432\u043E\u0441\u043F\u0440\u043E\u0438\u0437\u0432\u0435\u043B\u0438 \u043F\u0435\u0441\u0435\u043D\u043A\u0443 \u0442\u043E\u0447\u043D\u043E!","success"),currentIndex+=1,await wait(1300),setupRound()):setFeedback(feedback,"\u041F\u0435\u0441\u0435\u043D\u043A\u0430 \u0437\u0432\u0443\u0447\u0430\u043B\u0430 \u0438\u043D\u0430\u0447\u0435. \u041F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437.","error")}function finishGame(){setFeedback(feedback,`\u0411\u0440\u0430\u0432\u043E! \u0412\u044B \u043F\u043E\u0432\u0442\u043E\u0440\u0438\u043B\u0438 ${score} \u043C\u0435\u043B\u043E\u0434\u0438\u0439 \u0438\u0437 ${melodies.length}.`,"success"),updateProgress(progress,melodies.length,melodies.length),playButton.textContent="\u{1F501} \u0421\u044B\u0433\u0440\u0430\u0442\u044C \u0441\u043D\u043E\u0432\u0430",checkButton.disabled=!0}function restartGame(){currentIndex=0,score=0;const e=shuffle(melodies);melodies.splice(0,melodies.length,...e),playButton.textContent="\u25B6\uFE0F \u041F\u0440\u043E\u0438\u0433\u0440\u0430\u0442\u044C \u043C\u0435\u043B\u043E\u0434\u0438\u044E",setupRound()}playButton.addEventListener("click",()=>{currentIndex>=melodies.length?restartGame():playMelody()}),clearButton.addEventListener("click",clearSelection),checkButton.addEventListener("click",handleCheck),setupRound();
